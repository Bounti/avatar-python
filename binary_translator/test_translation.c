#include "lldc/c_interface.h"

#include <string.h>
#include <stdio.h>



unsigned read_code_memory(void *opaque, uint64_t address, unsigned size, uint8_t *buffer)
{
    static const char buffer_0x1146[] = "\xa0\x89\x72\x49\x08\x43\xa0\x81\x60\x8b\xff"
        "\x22\x41\x32\x10\x43\x60\x83\x20\x8b\xf0\x21\x08\x40\x6e\x49\x40\x18\x20"
        "\x83\xa0\x8b\xc0\x0b\xc0\x03\x7d\x30\xa0\x83\x60\x8b\x30\x43\x60\x83\x60"
        "\x8b\xb0\x43\x60\x83\xa0\x8b\x01\x21\xc9\x03\x08\x43\xa0\x83\xa0\x8b\x40"
        "\x04\x40\x0c\xa0\x83\x00\x20\x63\x49\x40\x1c\x88\x42\xfc\xd3\xe0\x89\x61"
        "\x49\x80\x0b\x80\x03\x40\x18\xe0\x81\xa0\x88\x5f\x49\xc0\x0b\xc0\x03\x40"
        "\x18\xa0\x80\xe0\x88\x5d\x49\x08\x40\xff\x30\xc0\x1c\xe0\x80\x20\x89\x5b"
        "\x49\xc0\x0b\xc0\x03\x40\x18\x20\x81\x60\x89\x59\x49\xc0\x0b\xc0\x03\x40"
        "\x18\x60\x81\x20\x8f\x57\x49\xc0\x0b\xc0\x03\x40\x18\x20\x87\x60\x8b\x90"
        "\x43\x60\x83\xa0\x89\x40\x0a\x40\x02\x20\x30\xa0\x81\x52\x48\x01\x68\x49"
        "\x08\x49\x00\x01\x60\x00\x22\x42\x60\x4f\x49\x81\x60\x4f\x49\x01\x62\x4f"
        "\x49\x41\x62\x4f\x49\x01\x62\x01\x68\x39\x43\x01\x60\x01\x68\xc9\x07\xfc"
        "\xd0";

    static const char buffer_0x128c[] = "\x00\x00\x0d\x40\x00\x08\x0a\x40\x40\x90\x01"
        "\x40\x00\x10\x0d\x40\xc8\x27\x00\x04\x80\x03\x0a\x40\xcc\x26\x00\x00\x84"
        "\x9c\x05\x06\x00\x00\x00\x00\x00\x2f\x04\x06\x80\x27\x01\x40\x00\x2a\x01"
        "\x40\xc0\x70\x03\x06\xc0\x1d\x00\x00\x9c\x03\x00\x04\x50\xc3\x05\x06\xac"
        "\xbf\x05\x06\x00\x30\x0d\x40\x40\x00\x10\x00\xb0\x1c\x00\x00\xbc\xc0\x05"
        "\x06\x07\x05\x00\x00\x96\xfa\xff\xff\x94\x00\x00\x04\x88\x03\x00\x04\x0d"
        "\x0a\x52\x73\x74\x20\x30\x78\x00\x00\x00\x00\x4d\x00\x00\x00\x00\x2b\x01"
        "\x40\x00\x90\x01\x40\x0d\xf0\xad\xde\xed\xfe\xad\xde\xc8\x03\x00\x04\xff"
        "\x01\x00\x00\x05\x39\x00\x00\xa0\x86\x01\x00\x6e\x2e\x00\x00\xc6\x7a\x00"
        "\x00\x01\xf8\xff\xff\x16\x0d\x00\x00\x42\x09\x00\x00\x0a\x19\x00\x00\x00"
        "\xa0\x0d\x40\x00\x00\xfe\x03\xff\xff\xff\x7f\x70\x47\x70\x47\xcc\x08\x00"
        "\x80\x00\x47\x01\x40\xa0\x00\x07\x40\x0a\x2b\x00\x00\x0b\x33\x00\x00\x0c"
        "\x2d\x00\x00\x36\x35\x00\x00\xaa\x72\x00\x00\x45\x4d\x00\x00\x6d\x71\x00"
        "\x00\x70\x47";

    printf("Reading address 0x%llx[%d]\n", address, size);
    
    if (address >= 0x1146 && address < 0x1218)
    {
        memcpy(buffer, &buffer_0x1146[address - 0x1146], size);
    }
    else if (address >=  0x128c && address < 0x1372)
    {
        memcpy(buffer, &buffer_0x128c[address - 0x128c], size);
    }
    else
    {
        printf("Invalid address requested: 0x%llx\n", address);
    }
    
    return size;
}

int main(int argc, char ** argv) 
{
    ProgramCounterRange pc_ranges[2];
    
    memset(pc_ranges, 0, sizeof(pc_ranges));
    pc_ranges[0].start = 0x1146;
    pc_ranges[0].end = 0x1218;
    instrument_memory_access("thumb", 0x1146, pc_ranges, 0x2000, read_code_memory, NULL, NULL, NULL);
}